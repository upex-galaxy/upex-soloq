# Implementation Plan: SQ-29 - Add Notes and Terms to Invoice

**Story:** [SQ-29](https://upexgalaxy64.atlassian.net/browse/SQ-29)
**Epic:** SQ-20 - Invoice Creation
**Created:** 2026-02-08
**Status:** In Progress

---

## Summary

Add notes and terms fields to invoice creation with:

- Character counters for both fields
- Default terms prefill from business profile
- Both fields optional (empty = not shown on PDF)

---

## Current State Analysis

### Existing Implementation

- `invoices.notes` column exists (text, nullable)
- Notes field exists in create form (no character counter)
- Notes saved via API `/api/invoices` POST

### Missing Components

| Component           | Current State         | Required                          |
| ------------------- | --------------------- | --------------------------------- |
| `invoices.terms`    | Column does not exist | Add text column (nullable)        |
| `bp.default_terms`  | Column does not exist | Add text column (nullable)        |
| Notes char counter  | Not implemented       | Add counter (max 2000)            |
| Terms field         | Not implemented       | Add textarea with counter         |
| Default terms fetch | Not implemented       | Fetch on mount, prefill if exists |
| Terms in API        | Not accepted          | Add to validation + insert        |

---

## Implementation Steps

### Step 1: Database Migration - Add terms to invoices

Add `terms` column to `invoices` table.

**File:** Migration via Supabase MCP
**SQL:**

```sql
ALTER TABLE invoices ADD COLUMN terms text;
COMMENT ON COLUMN invoices.terms IS 'Legal terms and conditions (max 1000 chars)';
```

---

### Step 2: Database Migration - Add default_terms to business_profiles

Add `default_terms` column to `business_profiles` table.

**File:** Migration via Supabase MCP
**SQL:**

```sql
ALTER TABLE business_profiles ADD COLUMN default_terms text;
COMMENT ON COLUMN business_profiles.default_terms IS 'Default terms pre-filled when creating invoices (max 1000 chars)';
```

---

### Step 3: Regenerate TypeScript Types

Run Supabase type generation to include new columns.

**Command:** `mcp__supabase__generate_typescript_types`

---

### Step 4: Update Validation Schema

Add `terms` field to invoice validation schemas.

**File:** `src/lib/validations/invoice.ts`
**Changes:**

```typescript
terms: z.string()
  .max(1000, 'Los t√©rminos no pueden exceder 1000 caracteres')
  .optional()
  .or(z.literal(''));
```

---

### Step 5: Create TextareaWithCounter Component

Reusable textarea with character counter for notes and terms.

**File:** `src/components/ui/textarea-with-counter.tsx`
**Features:**

- Current/max character display
- Visual indicator when near limit (90%+)
- Hard limit enforcement via `maxLength`
- Accessible counter with aria-describedby

---

### Step 6: Update Create Invoice Form

Add terms field and character counters to both fields.

**File:** `src/app/(app)/invoices/create/page.tsx`
**Changes:**

- Replace Textarea with TextareaWithCounter for notes
- Add terms field with TextareaWithCounter
- Fetch business profile to get default_terms
- Prefill terms with default_terms on mount

---

### Step 7: Update API Route

Accept terms field and persist to database.

**File:** `src/app/api/invoices/route.ts`
**Changes:**

- Destructure `terms` from validated data
- Include `terms` in insert query

---

### Step 8: Update Invoice Hook

Include terms in create mutation payload.

**File:** `src/hooks/invoices/use-create-invoice.ts`
**Changes:**

- Add terms to CreateInvoiceInput type

---

## Test Coverage Mapping

| Test Case                     | Implementation Step |
| ----------------------------- | ------------------- |
| Save notes with invoice       | Steps 4, 6, 7       |
| Prefill default terms         | Step 6              |
| Notes appear on invoice/PDF   | Future (PDF story)  |
| Character limit behavior      | Steps 4, 5, 6       |
| Sanitization (plain text)     | N/A (text input)    |
| Empty fields = hidden section | Future (PDF story)  |

---

## Definition of Done

- [x] Terms column added to invoices
- [x] Default_terms column added to business_profiles
- [ ] Notes field has character counter
- [ ] Terms field implemented with counter
- [ ] Default terms pre-fill working
- [ ] Character limits enforced (hard limit)
- [ ] Validation schema updated
- [ ] API accepts terms field
- [ ] TypeScript types regenerated
- [ ] Lint and build pass

---

## Notes

- Character limits: notes=2000, terms=1000 (aligned with existing validation)
- Hard limit via `maxLength` attribute (blocks further input)
- Both fields are plain text (no HTML/rich text in v1)
- PDF display will be handled in SQ-32/SQ-35

---

_Generated by Claude Code - 2026-02-08_
